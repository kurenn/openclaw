services:
  - type: web
    name: openclaw
    runtime: docker

    # Optional but recommended so Render's health checks hit something valid.
    # OpenClaw's Control UI is served from "/" on the gateway port.
    healthCheckPath: /

    # Persist config + workspace across deploys/restarts
    disk:
      name: openclaw-data
      mountPath: /data
      sizeGB: 10

    envVars:
      - key: OPENCLAW_STATE_DIR
        value: /data/.openclaw
      - key: OPENCLAW_WORKSPACE_DIR
        value: /data/workspace

      # Strongly recommended: use token auth when binding to LAN/public.
      # Set this in the Render dashboard (no quotes).
      # - key: OPENCLAW_GATEWAY_TOKEN
      #   value: <set-in-render-dashboard>

      # If you prefer password auth, set ONE of these in the Render dashboard (no quotes):
      # - OPENCLAW_GATEWAY_PASSWORD
      # - SETUP_PASSWORD

      - key: OPENCLAW_GATEWAY_TOKEN
        generateValue: true

    dockerCommand: |
      sh -lc '
        set -eu

        CONFIG_DIR="${OPENCLAW_STATE_DIR:-/data/.openclaw}"
        HOME_CONFIG_DIR="${HOME}/.openclaw"
        CONFIG_FILE="${CONFIG_DIR}/openclaw.json"

        mkdir -p "$CONFIG_DIR" "$HOME_CONFIG_DIR" "${OPENCLAW_WORKSPACE_DIR:-/data/workspace}"

        # Create default config ONLY if it doesn't exist (preserves persisted config)
        if [ ! -f "$CONFIG_FILE" ]; then
          cat > "$CONFIG_FILE" <<EOF
{"gateway":{"mode":"local","bind":"lan","controlUi":{"dangerouslyDisableDeviceAuth":true}}}
EOF
        fi

        # Ensure OpenClaw finds the config where it expects it
        ln -sf "$CONFIG_FILE" "$HOME_CONFIG_DIR/openclaw.json"

        # Build argv safely
        set -- node dist/index.js gateway --allow-unconfigured --bind lan --port "${PORT:-8080}"

        if [ -n "${OPENCLAW_GATEWAY_TOKEN:-}" ]; then
          set -- "$@" --auth token --token "$OPENCLAW_GATEWAY_TOKEN"
        elif [ -n "${OPENCLAW_GATEWAY_PASSWORD:-}" ]; then
          set -- "$@" --auth password --password "$OPENCLAW_GATEWAY_PASSWORD"
        elif [ -n "${SETUP_PASSWORD:-}" ]; then
          set -- "$@" --auth password --password "$SETUP_PASSWORD"
        fi

        exec "$@"
      '

